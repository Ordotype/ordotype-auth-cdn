!function(){"use strict";const e="memberstack.logout",t="memberstack.login",a="memberstack.validSession",o="memberstack.signUp",i=e=>{const t=new CustomEvent(a,{bubbles:!1,cancelable:!1,detail:{isStatusValid:e}});document.dispatchEvent(t)};class s extends Error{constructor(e,t=500,a){super(e),this.code=a,this.name="AuthError",this.status=t,Error.captureStackTrace&&Error.captureStackTrace(this,s)}status}class r extends Error{data;type;code;constructor(e,t,a){super(e),this.name="TwoFactorRequiredError",this.data=t,this.type=a,this.code="TWO_FACTOR_REQUIRED"}}class n extends s{constructor(e="User already exists"){super(e,409,"USER_ALREADY_EXISTS"),this.name="UserAlreadyExistsError",Object.setPrototypeOf(this,n.prototype)}}class c extends s{constructor(e="User is unauthorized"){super(e,401,"USER_UNAUTHORIZED"),this.name="UserUnauthorized",Object.setPrototypeOf(this,c.prototype)}}class d extends s{constructor(e="User is invalid"){super(e,400,"USER_INVALID"),this.name="UserInvalid",Object.setPrototypeOf(this,d.prototype)}}class l extends s{constructor(e="User is forbidden"){super(e,403,"USER_FORBIDDEN"),this.name="UserForbiddenError",Object.setPrototypeOf(this,l.prototype)}}class u extends s{constructor(e="An error occurred during authentication",t=500){super(e,t,"GENERIC_AUTH_ERROR"),this.name="GenericAuthError",Object.setPrototypeOf(this,u.prototype)}}function m(e){return"data"in e&&"object"==typeof e.data&&"type"in e}function h(e){return"email"in e&&"password"in e}class g extends Error{constructor(e,t,a,o){super(e),this.status=t,this.code=a,this.response=o,this.name="HttpError"}static async fromResponse(e){const t=await e.text();try{const a=JSON.parse(t);return new g(a.message||e.statusText,e.status,a.code,a)}catch{return new g(e.statusText,e.status)}}}function p(e){return"provider"in e}function w(e){return"email"in e&&"password"in e}function v(e){const t=e.cloneNode(!0);return e.parentNode&&e.parentNode.replaceChild(t,e),t}async function S(e,t){e.preventDefault(),e.stopImmediatePropagation();const a=e.target,o=a.querySelector('[data-ms-member="email"]')?.value,i=a.querySelector('[data-ms-member="password"]')?.value;"signup"===t?await y(a,{email:o,password:i}):"login"===t&&await f(a,{email:o,password:i})}async function f(e,t){let a;if(window.$memberstackDom._showLoader(),p(t))a={provider:t.provider};else{if(!w(t))throw new Error("Invalid form authentication options");a={email:t.email,password:t.password}}p(t)?await window.$memberstackDom.loginWithProvider(a):await window.$memberstackDom.loginMemberEmailPassword(a)}async function y(e,t){const a=function(e){const t={};return e.querySelectorAll("[data-ms-member]").forEach(e=>{const a=e.getAttribute("data-ms-member");a&&!["email","password","new-password","current-password"].includes(a)&&(t[a]=e.value||"")}),t}(e),{freePlan:o,paidPlan:i}=function(e){return{freePlan:e.getAttribute("data-ms-plan")||e.getAttribute("data-ms-plan:add")||e.getAttribute("data-ms-plan:update"),paidPlan:e.getAttribute("data-ms-price:add")}}(e);let s={customFields:a};if(p(t))s={allowLogin:!1,provider:t.provider};else{if(!w(t))throw new Error("Invalid form authentication options");s={email:t.email,password:t.password}}o&&(s.plans=[{planId:o}]);try{window.$memberstackDom._showLoader(),p(t)?await window.$memberstackDom.signupWithProvider({...s,paidPlan:i}):await window.$memberstackDom.signupMemberEmailPassword({...s,paidPlan:i})}catch(r){await async function(e,t){console.log("submitFormError",e,t),await window.$memberstackDom._showMessage(t?.message||"An error occurred",!0)}("Signup failed:",r),window.$memberstackDom._hideLoader()}}function E(e){const t=e.querySelector("[data-ms-member='email']"),a=e.querySelector("[data-ms-member='password']");t&&(t.type="email"),a&&(a.type="password");const o=async t=>{if(e.hasAttribute("data-ordo-processing"))return t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1;e.setAttribute("data-ordo-processing","true"),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();try{await S(t,"signup")}finally{e.removeAttribute("data-ordo-processing")}return!1};e.addEventListener("submit",o,!0),e.addEventListener("submit",o,!1)}function b(e){const t=e.querySelector("[data-ms-member='email']"),a=e.querySelector("[data-ms-member='password']");t&&(t.type="email"),a&&(a.type="password");const o=t=>e.hasAttribute("data-ordo-processing")?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),!1):(e.setAttribute("data-ordo-processing","true"),t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),Promise.resolve().then(()=>S(t,"login")).finally(()=>{e.removeAttribute("data-ordo-processing")}),!1);e.addEventListener("submit",o,!0),e.addEventListener("submit",o,!1)}function I(e){e?window.telemetryBeacon.setUser(e.id,e.auth.email):window.telemetryBeacon.clearUser()}const L="/challenge,/signup,/login,/successful-login".split(",").map(e=>new RegExp(e));function M(){const e=window.memberstackConfig?.forceProd;return!0===e||"www.ordotype.fr"===location.host}const R=new class{getItem(e){return sessionStorage.getItem(e)}setItem(e,t){sessionStorage.setItem(e,t)}removeItem(e){sessionStorage.removeItem(e)}hasItem(e){return null!==sessionStorage.getItem(e)}getJSON(e){const t=this.getItem(e);return t?JSON.parse(t):null}setJSON(e,t){this.setItem(e,JSON.stringify(t))}clear(){sessionStorage.clear()}};const k=new class{getItem(e){return localStorage.getItem(e)}setItem(e,t){localStorage.setItem(e,t)}removeItem(e){localStorage.removeItem(e)}hasItem(e){return null!==localStorage.getItem(e)}getJSON(e){const t=this.getItem(e);return t?JSON.parse(t):null}clear(){localStorage.clear()}};const A=new class{KEYS={MEMBER_ID:"_ms-mid",MEMBER:"_ms-mem"};getMember(){return k.getJSON(this.KEYS.MEMBER)}saveMember({member:e,token:t}){k.setItem(this.KEYS.MEMBER,JSON.stringify(e)),k.setItem(this.KEYS.MEMBER_ID,t)}getAuthToken(){return k.getItem(this.KEYS.MEMBER_ID)}saveAuthToken(e){k.setItem(this.KEYS.MEMBER_ID,e)}hasMember(){return k.hasItem(this.KEYS.MEMBER)}clearAuth(){k.removeItem(this.KEYS.MEMBER),k.removeItem(this.KEYS.MEMBER_ID)}};class T{baseUrl;defaultHeaders;constructor(e,t={}){this.baseUrl=e,this.defaultHeaders=t}async request(e,t="GET",a=null,o={},i){const s=`${this.baseUrl}/${e}`,r={method:t,headers:{"Content-Type":"application/json",...this.defaultHeaders,...o},...a&&{body:JSON.stringify(a)},signal:i};try{const e=await fetch(s,r);if(!e.ok)throw await g.fromResponse(e);if(204===e.status||!e.body)return null;const t=await e.text();return t?JSON.parse(t):null}catch(n){if(n instanceof DOMException&&"AbortError"===n.name)return console.warn("Request was canceled:",n),null;throw n}}}const P=function(){const e=M()?"pk_97bbd1213f5b1bd2fc0f":"pk_sb_e80d8429a51c2ceb0530",t=M()?"https://api.ordotype.fr/v1.0.0":"https://staging-api.ordotype.fr/v1.0.0";return new T(t,{"X-Api-Key":e})}(),_="sessionInitTime";const D=new class{createSessionInitTime(){const e=new Date;k.setItem(_,e.toISOString())}deleteSessionInitTime(){k.removeItem(_)}getSessionInitTime(){const e=k.getItem(_);return e?new Date(e):null}calculateSessionLifetime(){const e=this.getSessionInitTime();if(!e)return{hours:0,minutes:0,seconds:0,formatted:"undefined",documentReferrer:document.referrer};const t=(new Date).getTime()-e.getTime(),a=Math.floor(t/1e3),o=Math.floor(a/3600),i=Math.floor(a%3600/60),s=a%60,r=e=>e.toString().padStart(2,"0");return{hours:o,minutes:i,seconds:s,formatted:`${r(o)}:${r(i)}:${r(s)}`,documentReferrer:document.referrer}}getDeviceId(){const e=document.cookie.split("; ");for(const a of e){const[e,t]=a.split("=");if("_ga_7T2LX34911"===e){if(new Set(["deleted","opt-out","blocked",""]).has(t))break;return t}}const t=this.getMsSessionId();return t&&t.length>0?(console.warn("No GA cookie found. Using ms session id value."),localStorage.getItem("ms_session_id")):(console.warn("No device id found. Using default value."),"unknown-device-id")}getMsSessionId(){return k.getItem("ms_session_id")}},O=new class{constructor(e,t,a){this.apiClient=e,this.authRepository=t,this.sessionService=a}async validateSessionStatus(){const e=new AbortController,t=this.authRepository.getAuthToken(),a=this.sessionService.getMsSessionId(),o=this.sessionService.getDeviceId();try{return await this.apiClient.request("auth/validate-session-status","POST",null,{Authorization:`Bearer ${t}`,...a&&{"X-Session-Id":a},...o&&{"X-Device-Id":o}},e.signal)}catch(i){if(i instanceof g&&401===i.status)throw new c(i.message);if(i instanceof g&&403===i.status)throw new l(i.message);throw console.error("Session validation failed:",i),new u(i instanceof Error?i.message:"Session validation failed",500)}}async logout(){const e=this.authRepository.getAuthToken();try{await this.apiClient.request("auth/logout","POST",null,{Authorization:`Bearer ${e}`})}catch(t){if(t instanceof g&&(401===t.status||403===t.status))throw new l(t.message);throw new u(t instanceof Error?t.message:"Logout failed",500)}}async signup(e){try{const t=this.sessionService.getDeviceId(),a={...e,device:t??"unknown"};return await this.apiClient.request("auth/signup","POST",a)}catch(t){if(t instanceof g){if("invalid-email"===t.code)throw new d(t.message);if("invalid-password-to-short"===t.code)throw new d(t.message);if("email-already-in-use"===t.code||409===t.status)throw new n(t.message)}throw new u(t instanceof Error?t.message:"Signup failed",500)}}async login(e){try{const t=this.sessionService.getDeviceId(),a={...e,options:{includeContentGroups:!0,isWebflow:!0},device:t??"unknown"},o=await this.apiClient.request("auth/login","POST",a);if(o&&m(o))throw new r("2fa required",o.data,o.type);return o}catch(t){if(t instanceof r)throw t;if(t instanceof g&&"invalid-credentials"===t.code)throw new c(t.message);throw new u(t instanceof Error?t.message:"Login failed",500)}}async loginWithProvider(e){try{const t=this.sessionService.getDeviceId(),a={...e,device:t??"unknown"},o=await this.apiClient.request("auth/validate-google-provider","POST",a);if(o&&m(o))throw new r("2fa required",o.data,o.type);return o}catch(t){if(t instanceof r)throw t;throw new u(t instanceof Error?t.message:"Login with provider failed",500)}}}(P,A,D),N=new class{showLoader(){window.$memberstackDom._showLoader()}hideLoader(){window.$memberstackDom._hideLoader()}async showMessage(e,t=!1){await window.$memberstackDom._showMessage(e,t)}},C=new class{constructor(e){this.uiService=e}navigateTo(e){window.location.href=e}async navigateWithLoader(e,t=700){this.uiService.showLoader(),await new Promise(e=>setTimeout(e,t)),this.navigateTo(e)}}(N),x=new class{KEYS={SESSION:"_ms-2fa-session",EMAIL:"ms_email",TIMER_LEFT:"timer_timeLeft",OTP_TIMER_LEFT:"otp_timer_timeLeft",TIMER:"_ms-2fa-timer",TIMER_START:"_ms-2fa-timer-start"};get2FASession(){return R.getJSON(this.KEYS.SESSION)}save2FASession(e){R.setJSON(this.KEYS.SESSION,e)}getEmail(){return R.getItem(this.KEYS.EMAIL)}saveEmail(e){R.setItem(this.KEYS.EMAIL,e)}getTimerLeft(){const e=R.getItem(this.KEYS.TIMER_LEFT);return e?parseInt(e,10):null}saveTimerLeft(e){R.setItem(this.KEYS.TIMER_LEFT,e.toString())}clearAll(){Object.values(this.KEYS).forEach(e=>{R.removeItem(e)})}has2FASession(){return R.hasItem(this.KEYS.SESSION)}},U=new class{constructor(e,t,a,o,i){this.authService=e,this.authRepository=t,this.navigationService=a,this.uiService=o,this.twoFactorRepository=i}async handleLogin(e){try{if(!e&&this.isMemberLoggedIn())return this.uiService.hideLoader(),void(await this.uiService.showMessage("Vous êtes déjà connecté.",!0));h(e)?await this.handleEmailPasswordLogin(e):await this.handleProviderLogin(e)}catch(t){await this.handleLoginError(t,e)}}async handleEmailPasswordLogin(e){const t=await this.authService.login(e);this.authRepository.saveMember({member:t.data.member,token:t.data.tokens.accessToken}),I(t.data.member),this.navigationService.navigateTo(t.data.member.loginRedirect)}async handleProviderLogin(e){const t=await this.authService.loginWithProvider({loginResponse:e});if(null===t){const e=this.authRepository.getMember();return void(await this.navigationService.navigateWithLoader(e?.loginRedirect||"/"))}I(t.data.member),await this.navigationService.navigateWithLoader(t.data.member.loginRedirect)}isMemberLoggedIn(){return this.authRepository.hasMember()}async handleLoginError(e,t){if(e instanceof r)await this.handle2FARequired(e,t);else{if(!this.isNetworkTimeout(e)){if(e instanceof s&&500!==e.status)return await this.uiService.showMessage(e.message,!0),void this.uiService.hideLoader();throw await this.uiService.showMessage("Il y a eu une erreur avec votre demande.",!0),this.uiService.hideLoader(),console.error("[Login] Unexpected error:",e),e}await this.handleNetworkTimeout()}}async handle2FARequired(e,t){this.authRepository.clearAuth(),this.twoFactorRepository.clearAll();let a="";a=h(t)?t.email:e.data.email||"unknown",this.twoFactorRepository.saveEmail(a),this.twoFactorRepository.save2FASession({data:e.data,type:e.type});const o=(M(),"/membership/connexion-2fa");await this.navigationService.navigateWithLoader(o)}async handleNetworkTimeout(){const e=this.authRepository.getMember();e?.loginRedirect?await this.navigationService.navigateWithLoader(e.loginRedirect):await this.uiService.showMessage("La connexion a pris trop de temps. Veuillez réessayer.",!0),this.uiService.hideLoader()}isNetworkTimeout(e){return"object"==typeof e&&null!==e&&"code"in e&&("ECONNABORTED"===e.code||"ETIMEDOUT"===e.code)}}(O,A,C,N,x),q=new class{constructor(e,t,a,o){this.authRepository=e,this.uiService=t,this.authService=a,this.navigationService=o}async handleLogout(e){if(this.authRepository.getMember())if(e)await this.uiService.showMessage("Votre session a expiré. Veuillez vous reconnecter.",!0);else try{this.uiService.showLoader(),await this.authService.logout(),I(null),await this.navigationService.navigateWithLoader("/")}catch(t){await this.handleLogoutError(t)}finally{this.authRepository.clearAuth(),this.uiService.hideLoader()}else console.log("Member is not logged in.")}async handleLogoutError(e){if(!(e instanceof l))throw await this.uiService.showMessage("Il y a eu une erreur avec votre demande.",!0),console.error("[Logout] Unexpected error:",e),e;console.log("Member is already logged out from the server.")}}(A,N,O,C),$=new class{constructor(e,t,a){this.authService=e,this.navigationService=t,this.uiService=a}async handleSignup(e,t){try{await this.authService.signup({token:e.data.tokens.accessToken}),I(e.data.member),t?await window.$memberstackDom.purchasePlansWithCheckout({priceId:t}):this.navigationService.navigateTo(e.data.redirect),this.uiService.hideLoader()}catch(a){await this.handleSignupError(a)}}async handleSignupError(e){if(e instanceof s&&500!==e.status)return await this.uiService.showMessage(e.message,!0),void this.uiService.hideLoader();throw await this.uiService.showMessage("Il y a eu une erreur avec votre inscription.",!0),this.uiService.hideLoader(),console.error("[SignUp] Unexpected error:",e),e}}(O,C,N),F=new class{constructor(e,t){this.authRepository=e,this.authService=t}async dispatchValidateSession(){if(this.authRepository.getMember())try{if(!1===await this.authService.validateSessionStatus())return void(await window.$memberstackDom.logout());i(!0)}catch(e){await this.handleDispatchValidateSessionError(e)}else i("unauthenticated")}async handleDispatchValidateSessionError(e){if(e instanceof l)return console.warn("[ValidateSession] Forbidden Resource"),void(await window.$memberstackDom.logout({isExpired:!0}));throw console.error("[ValidateSession] Unexpected error:",e),e}}(A,O),K=new class{constructor(e,t,a,o,i){this.loginController=e,this.signupController=t,this.logoutController=a,this.validateSessionController=o,this.telemetryService=i}async login(e){try{const t=e.detail??void 0;await this.telemetryService.trackAsyncSpan({name:"auth/login",op:"auth.login"},async()=>await this.loginController.handleLogin(t))}catch(t){this.telemetryService.captureException({error:t,tags:{operation_name:"auth/login",feature:"auth"}})}}async signup(e){try{const[t,a]=e.detail??[];await this.telemetryService.trackAsyncSpan({name:"auth/signup",op:"auth.signup"},async()=>await this.signupController.handleSignup(t,a))}catch(t){this.telemetryService.captureException({error:t,tags:{operation_name:"auth/signup",feature:"auth"}})}}async logout(e){try{const{isExpired:t}=e.detail??{};await this.telemetryService.trackAsyncSpan({name:"auth/logout",op:"auth.logout"},async()=>await this.logoutController.handleLogout(t))}catch(t){this.telemetryService.captureException({error:t,tags:{operation_name:"auth/logout",feature:"auth"}})}}async emitValidateSessionStatus(){var e;if(e=location.href,L.some(t=>t.test(e)))console.log("Avoided verification on excluded page");else try{await this.telemetryService.trackAsyncSpan({name:"auth/validate",op:"auth.validate"},async()=>await this.validateSessionController.dispatchValidateSession())}catch(t){this.telemetryService.captureException({error:t,tags:{operation_name:"auth/validate",feature:"auth"}})}}}(U,$,q,F,window.telemetryBeacon);!async function(){let a=!1,i=!1,s=!1;async function r(){a&&i&&!s&&(s=!0,console.log("ordo auth init - both events ready"),await async function(){(function(a){if(!a)throw new Error("Memberstack instance is not defined");window._msConfig||(window._msConfig={preventLogin:!0,preventFormSubmission:!0,preventAutoLogin:!0}),window.$memberstackDom=new Proxy(a,{get(a,i){const s=a[i];return"function"==typeof s?async function(...r){if("loginMemberEmailPassword"!==i?console.log(`Method ${i} called with arguments: ${JSON.stringify(r)}`):console.log(`Method ${i} called with arguments: ${JSON.stringify(r[0].email)}, "password": "*****"`),"logout"===i){const t=new CustomEvent(e,{bubbles:!1,cancelable:!1,detail:r[0]});return document.dispatchEvent(t),!1}if("loginMemberEmailPassword"===i){const e=new CustomEvent(t,{bubbles:!1,cancelable:!1,detail:r[0]});return document.dispatchEvent(e),{data:{}}}if("loginWithProvider"===i){let e;try{e=await s.apply(a,r)}catch(n){throw n}const o=new CustomEvent(t,{bubbles:!1,cancelable:!1,detail:e});return document.dispatchEvent(o),e}if("signupWithProvider"===i){let e;const t=r[0],{paidPlan:i,...c}=t;try{e=await s.apply(a,[c])}catch(n){throw n}const d=new CustomEvent(o,{bubbles:!1,cancelable:!1,detail:[e,i]});return document.dispatchEvent(d),e}if("signupMemberEmailPassword"===i){let e;const t=r[0],{paidPlan:i,...c}=t;try{e=await s.apply(a,[c])}catch(n){throw n}const d=new CustomEvent(o,{bubbles:!1,cancelable:!1,detail:[e,i]});return document.dispatchEvent(d),e}if("getMemberCookie"===i){const e=await await s.apply(a,r);return String(e).toString()}return s.apply(a,r)}:s}})})(window.$memberstackDom),function(){const e=document.querySelector('[data-ordo-form="signup"]'),t=document.querySelector('[data-ms-form="signup"]');e&&E(v(e));t&&E(v(t));e||t||console.warn("no signup form found.");const a=document.querySelector('[data-ordo-form="login"]'),o=document.querySelector('[data-ms-form="login"]');a&&b(v(a));o&&b(v(o));a||o||console.warn("no login form found."),(document.querySelectorAll('[data-ordo-auth-provider="google"]').length?document.querySelectorAll('[data-ordo-auth-provider="google"]'):document.querySelectorAll('[data-ms-auth-provider="google"]')).forEach(e=>{e.addEventListener("click",t=>{const a=e.closest("[data-ordo-form]")||e.closest("[data-ms-form]");a&&(t.stopImmediatePropagation(),t.preventDefault(),"signup"===a.getAttribute("data-ms-form")?Promise.resolve().then(()=>y(a,{provider:"google"})):Promise.resolve().then(()=>f(0,{provider:"google"})))},!0)}),(document.querySelectorAll('[data-ordo-action="logout"]').length?document.querySelectorAll('[data-ordo-action="logout"]'):document.querySelectorAll('[data-ms-action="logout"]')).forEach(e=>{const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),t.addEventListener("click",async function(e){e.stopImmediatePropagation(),e.preventDefault(),await window.$memberstackDom.logout()},!0)})}();I(A.getMember()),await K.emitValidateSessionStatus()}())}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",async()=>{i=!0,await r()}):i=!0,window.$memberstackReady?(a=!0,await r()):document.addEventListener("memberstack.ready",async()=>{a=!0,await r()})}(),document.addEventListener(e,async e=>{await K.logout(e)}),document.addEventListener(t,async e=>{await K.login(e)},{capture:!0}),document.addEventListener(o,async e=>{await K.signup(e)},{capture:!0})}();
