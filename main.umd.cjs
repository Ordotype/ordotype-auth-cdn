!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e=Object.defineProperty,t=(t,o,a)=>((t,o,a)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[o]=a)(t,"symbol"!=typeof o?o+"":o,a);const o="memberstack.logout",a="memberstack.getApp",n="memberstack.login",i="memberstack.validSession",s="memberstack.signUp";class r extends Error{constructor(e,o=500){super(e),t(this,"status"),this.name="AuthError",this.status=o,Error.captureStackTrace&&Error.captureStackTrace(this,r)}}class c extends Error{constructor(e,o,a){super(e),t(this,"data"),t(this,"type"),this.name="TwoFactorRequiredError",this.data=o,this.type=a}}class l{constructor(){t(this,"headers");const e=window.localStorage.getItem("ms_session_id"),o=function(){const e=document.cookie.split("; ");for(const t of e){const[e,o]=t.split("=");if("_ga_7T2LX34911"===e)return o}throw new Error("Device Id cookie not found")}();this.headers={"X-Api-Key":"pk_sb_e80d8429a51c2ceb0530","X-Session-Id":e??void 0,"X-Device-Id":o??void 0}}async request(e,t,o="GET",a=null,n={}){const i=`https://staging-api.ordotype.fr/v1.0.0/${t}/${e}`,s={method:o,headers:{"Content-Type":"application/json",...this.headers,...n},...a&&{body:JSON.stringify(a)}};try{const e=await fetch(i,s);if(!e.ok)throw new r(e.statusText,e.status);return 204!==e.status&&e.body?await e.json():null}catch(c){throw console.error("API Request Failed:",c),c}}async validateSessionStatus(){try{const e=localStorage.getItem("_ms-mid");return await this.request("validate-session-status","auth","POST",null,{Authorization:`Bearer ${e}`})}catch(e){throw console.error("Session validation failed:",e),e}}async logout(){try{const e=localStorage.getItem("_ms-mid");await this.request("logout","auth","POST",null,{Authorization:`Bearer ${e}`}),localStorage.removeItem("_ms-mid")}catch(e){throw console.error("Session logout failed:",e),e}}async signup(e){const t={...e,device:this.headers["X-Device-Id"]??"unknown"};return await this.request("signup","auth","POST",t,{})}async login(e){const t={...e,options:{includeContentGroups:!0,isWebflow:!0},device:this.headers["X-Device-Id"]??"unknown"},o=await this.request("login","auth","POST",t,{});if(d(o))throw new c("2fa required",o.data,o.type);return o}async loginWithProvider(e){const t={...e,device:this.headers["X-Device-Id"]??"unknown"},o=await this.request("validate-google-provider","auth","POST",t,{});if(d(o))throw new c("2fa required",o.data,o.type);return o}getCookie(e){const t=document.cookie.match(new RegExp(`(^| )${e}=([^;]+)`));return t?decodeURIComponent(t[2]):null}setCookie(e,t,o){const a=new Date;a.setTime(a.getTime()+o),document.cookie=`${e}=${encodeURIComponent(t)}; expires=${a.toUTCString()}; path=/`}async throttle(e,t,o){const a=this.getCookie(t),n=Date.now();if(a&&n-parseInt(a,10)<o)return console.log(`Skipping execution of ${t}: Throttled.`),null;console.log(`Executing ${t}...`);const i=await e();return this.setCookie(t,n.toString(),o),i}validateSessionStatusThrottled(){return localStorage.getItem("_ms-mid")?this.throttle((()=>this.validateSessionStatus()),"lastSessionValidation",18e4):Promise.resolve(null)}}function d(e){return"data"in e&&"object"==typeof e.data&&"type"in e}function u(){return!!localStorage.getItem("_ms-mid")}function m(e){window.$memberstackDom._showLoader(),setTimeout((()=>{window.location.href=e}),500)}new l;const w=e=>{const t=new CustomEvent(i,{bubbles:!1,cancelable:!1,detail:{isStatusValid:e}});document.dispatchEvent(t)};!function(e){if(!e)throw new Error("Memberstack instance is not defined");window._msConfig||(window._msConfig={preventLogin:!0}),window.$memberstackDom=new Proxy(e,{get(e,t){const i=e[t];return"function"==typeof i?async function(...r){if(console.log(`Method ${t} called with arguments: ${JSON.stringify(r)}`),"logout"===t){const e=new CustomEvent(o,{bubbles:!1,cancelable:!1,detail:r[0]});return document.dispatchEvent(e),!1}if("getApp"===t){const e=new Event(a,{bubbles:!1,cancelable:!1});document.dispatchEvent(e)}if("loginMemberEmailPassword"===t){const e=new CustomEvent(n,{bubbles:!1,cancelable:!1,detail:r[0]});return document.dispatchEvent(e),{data:{}}}if("loginWithProvider"===t){const t=await i.apply(e,r),o=new CustomEvent(n,{bubbles:!1,cancelable:!1,detail:t});return document.dispatchEvent(o),t}if("signupWithProvider"===t){const t=await i.apply(e,r),o=new CustomEvent(s,{bubbles:!1,cancelable:!1,detail:t});return document.dispatchEvent(o),t}if("signupMemberEmailPassword"===t){const t=await i.apply(e,r),o=new CustomEvent(s,{bubbles:!1,cancelable:!1,detail:t});return document.dispatchEvent(o),t}if("getMemberCookie"===t){const t=await await i.apply(e,r);return String(t).toString()}return i.apply(e,r)}:i}})}(window.$memberstackDom);const p=new l,g="/default".split(",").map((e=>new RegExp(e)));document.addEventListener(a,(async()=>{var e;if(e=location.href,g.some((t=>t.test(e))))console.log("Avoided verification on excluded page");else if(console.log("getApp"),u())try{if(!1===await p.validateSessionStatus())return void(await window.$memberstackDom.logout());w(!0)}catch(t){if(t instanceof r)return void(401!==t.status&&403!==t.status||await window.$memberstackDom.logout({isExpired:!0}))}else w("unauthenticated")}),{once:!0}),document.addEventListener(o,(async e=>{const{detail:t}=e;if(console.log("logout"),u()){if(null==t?void 0:t.isExpired)await window.$memberstackDom._showMessage("Votre session a expiré. Veuillez vous reconnecter.",!0);else try{await p.logout()}catch(o){o instanceof r&&(401!==o.status&&403!==o.status||console.log("Member is already logged out from the server."))}await(async(e,t="/")=>{localStorage.removeItem("_ms-mid"),localStorage.removeItem("_ms-mem"),m(t)})(0,"/")}else console.log("Member is not logged in.")})),document.addEventListener(n,(async e=>{console.log("login");const t=e.detail;if(!t&&u())return console.log("Member is already logged in."),void(await window.$memberstackDom._showMessage("Vous êtes déjà connecté.",!0));try{if(function(e){return"email"in e&&"password"in e}(t)){const e=await p.login({email:t.email,password:t.password});localStorage.setItem("_ms-mid",e.data.tokens.accessToken),localStorage.setItem("_ms-mem",JSON.stringify(e.data.member)),window.location.href=e.data.redirect}else{const e=await p.loginWithProvider({loginResponse:t});window.location.href=e.data.redirect}}catch(o){if(o instanceof c){localStorage.removeItem("_ms-mid");const e="_ms-2fa-session",t=JSON.stringify({data:o.data,type:o.type});return sessionStorage.setItem(e,t),void m("/src/pages/2factor-challenge/")}throw o}})),document.addEventListener(s,(async e=>{const t=e.detail;await p.signup({token:t.data.tokens.accessToken})})),function(){var e,t;function o(e){return"provider"in e}function a(e){return"email"in e&&"password"in e}async function n(e,t){console.error(e,t),await window.$memberstackDom._showMessage((null==t?void 0:t.message)||"An error occurred",!0)}async function i(e,t){var o,a;e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const n=e.target,i=null==(o=n.querySelector('[data-ms-member="email"]'))?void 0:o.value,c=null==(a=n.querySelector('[data-ms-member="password"]'))?void 0:a.value;"signup"===t?await r(n,{email:i,password:c}):"login"===t&&await s(n,{email:i,password:c})}async function s(e,t){let i;if(o(t))i={provider:t.provider};else{if(!a(t))throw new Error("Invalid form authentication options");i={email:t.email,password:t.password}}try{const e=o(t)?await window.$memberstackDom.loginWithProvider(i):await window.$memberstackDom.loginMemberEmailPassword(i);console.log("Signin successful:",e)}catch(s){await n("Login failed:",s)}}async function r(e,t){const i=function(e){const t={};return e.querySelectorAll("[data-ms-member]").forEach((e=>{const o=e.getAttribute("data-ms-member");o&&!["email","password","new-password","current-password"].includes(o)&&(t[o]=e.value||"")})),t}(e),{freePlan:s,paidPlan:r}=function(e){return{freePlan:e.getAttribute("data-ms-plan")||e.getAttribute("data-ms-plan:add")||e.getAttribute("data-ms-plan:update"),paidPlan:e.getAttribute("data-ms-price:add")}}(e);let c={customFields:i};if(o(t))c={allowLogin:!1,provider:t.provider};else{if(!a(t))throw new Error("Invalid form authentication options");c={email:t.email,password:t.password}}s&&(c.plans=[{planId:s}]);try{window.$memberstackDom._showLoader();const e=o(t)?await window.$memberstackDom.signupWithProvider(c):await window.$memberstackDom.signupMemberEmailPassword(c);console.log("Signup successful:",e),r?await window.$memberstackDom.purchasePlansWithCheckout({priceId:r}):m(e.data.redirect),window.$memberstackDom._hideLoader()}catch(l){await n("Signup failed:",l),window.$memberstackDom._hideLoader()}}null==(e=document.querySelector('[data-ms-form="signup"]'))||e.addEventListener("submit",(async e=>(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),await i(e,"signup"),!1))),null==(t=document.querySelector('[data-ms-form="login"]'))||t.addEventListener("submit",(async e=>(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),await i(e,"login"),!1))),document.querySelectorAll('[data-ms-auth-provider="google"]').forEach((e=>{e.addEventListener("click",(async t=>{t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();const o=e.closest("[data-ms-form]");o?"signup"===o.getAttribute("data-ms-form")?await r(o,{provider:"google"}):await s(0,{provider:"google"}):console.warn("No parent form with 'data-ms-form' found.")}))})),document.querySelectorAll('[data-ms-action="logout"]').forEach((e=>{e.addEventListener("click",(async function(e){e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),await window.$memberstackDom.logout()}))}))}()}));
