!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";const e="memberstack.logout",t="memberstack.login",o="memberstack.validSession",n="memberstack.signUp";function a(){const e=window.memberstackConfig?.forceProd;return!0===e||"www.ordotype.fr"===location.host}const r=a()?"https://api.ordotype.fr/v1.0.0":"https://staging-api.ordotype.fr/v1.0.0";class s extends Error{status;constructor(e,t=500){super(e),this.name="AuthError",this.status=t,Error.captureStackTrace&&Error.captureStackTrace(this,s)}}class i extends Error{data;type;constructor(e,t,o){super(e),this.name="TwoFactorRequiredError",this.data=t,this.type=o}}class c{headers;constructor(){const e=a()?"pk_97bbd1213f5b1bd2fc0f":"pk_sb_e80d8429a51c2ceb0530",t=window.localStorage.getItem("ms_session_id"),o=function(){const e=document.cookie.split("; ");for(const o of e){const[e,t]=o.split("=");if("_ga_7T2LX34911"===e)return t}const t=localStorage.getItem("ms_session_id");return t&&t.length>0?(console.warn("No GA cookie found. Using ms session id value."),localStorage.getItem("ms_session_id")):(console.warn("No device id found. Using default value."),"unknown-device-id")}();this.headers={"X-Api-Key":e,"X-Session-Id":t??void 0,"X-Device-Id":o??void 0}}async request(e,t,o="GET",n=null,a={},i){const c=`${r}/${t}/${e}`,d={method:o,headers:{"Content-Type":"application/json",...this.headers,...a},...n&&{body:JSON.stringify(n)},signal:i};try{const e=await fetch(c,d);if(!e.ok){const t=await e.text();if(t){const o=JSON.parse(t);throw new s(o.message,e.status)}throw new s(e.statusText,e.status)}if(204===e.status||!e.body)return null;if(e){const t=await e.text();return t?JSON.parse(t):null}return null}catch(m){if(m instanceof DOMException&&"AbortError"===m.name)return console.warn("Request was canceled:",m),null;throw m}}async validateSessionStatus(){const e=new AbortController;try{const t=localStorage.getItem("_ms-mid");return await this.request("validate-session-status","auth","POST",null,{Authorization:`Bearer ${t}`},e.signal)}catch(t){throw console.error("Session validation failed:",t),t}}async logout(){try{const e=localStorage.getItem("_ms-mid");await this.request("logout","auth","POST",null,{Authorization:`Bearer ${e}`}),localStorage.removeItem("_ms-mid")}catch(e){throw console.error("Session logout failed:",e),e}}async signup(e){const t={...e,device:this.headers["X-Device-Id"]??"unknown"};return await this.request("signup","auth","POST",t,{})}async login(e){const t={...e,options:{includeContentGroups:!0,isWebflow:!0},device:this.headers["X-Device-Id"]??"unknown"},o=await this.request("login","auth","POST",t,{});if(d(o))throw new i("2fa required",o.data,o.type);return o}async loginWithProvider(e){const t={...e,device:this.headers["X-Device-Id"]??"unknown"},o=await this.request("validate-google-provider","auth","POST",t,{});if(o&&d(o))throw new i("2fa required",o.data,o.type);return o}getCookie(e){const t=document.cookie.match(new RegExp(`(^| )${e}=([^;]+)`));return t?decodeURIComponent(t[2]):null}setCookie(e,t,o){const n=new Date;n.setTime(n.getTime()+o),document.cookie=`${e}=${encodeURIComponent(t)}; expires=${n.toUTCString()}; path=/`}async throttle(e,t,o){const n=this.getCookie(t),a=Date.now();if(n&&a-parseInt(n,10)<o)return console.log(`Skipping execution of ${t}: Throttled.`),null;console.log(`Executing ${t}...`);const r=await e();return this.setCookie(t,a.toString(),o),r}validateSessionStatusThrottled(){return localStorage.getItem("_ms-mid")?this.throttle((()=>this.validateSessionStatus()),"lastSessionValidation",18e4):Promise.resolve(null)}}function d(e){return"data"in e&&"object"==typeof e.data&&"type"in e}function m(){const e=localStorage.getItem("_ms-mid");return console.log("isMemberLoggedIn",!!e),!!e}function l(e){window.$memberstackDom._showLoader(),console.log("navigating to: ",e),setTimeout((()=>{window.location.href=e}),700)}new c;const u=async(e,t="/")=>{localStorage.removeItem("_ms-mid"),localStorage.removeItem("_ms-mem"),localStorage.removeItem(g),l(t)},w=e=>{const t=new CustomEvent(o,{bubbles:!1,cancelable:!1,detail:{isStatusValid:e}});document.dispatchEvent(t)},g="sessionInitTime";function f(){const e=new Date;localStorage.setItem(g,e.toISOString())}function p(){const e=function(){const e=localStorage.getItem(g);return e?new Date(e):null}();if(!e)return{hours:0,minutes:0,seconds:0,formatted:"undefined",documentReferrer:document.referrer};const t=(new Date).getTime()-e.getTime(),o=Math.floor(t/1e3),n=Math.floor(o/3600),a=Math.floor(o%3600/60),r=o%60,s=e=>e.toString().padStart(2,"0");return{hours:n,minutes:a,seconds:r,formatted:`${s(n)}:${s(a)}:${s(r)}`,documentReferrer:document.referrer}}function h(e){return"provider"in e}function b(e){return"email"in e&&"password"in e}async function v(e,t){console.log("submitFormError",e,t),await window.$memberstackDom._showMessage(t?.message||"An error occurred",!0)}async function y(e,t){e.preventDefault(),e.stopImmediatePropagation();const o=e.target,n=o.querySelector('[data-ms-member="email"]')?.value,a=o.querySelector('[data-ms-member="password"]')?.value;"signup"===t?await k(o,{email:n,password:a}):"login"===t&&await S(o,{email:n,password:a})}async function S(e,t){let o;if(window.$memberstackDom._showLoader(),h(t))o={provider:t.provider};else{if(!b(t))throw new Error("Invalid form authentication options");o={email:t.email,password:t.password}}try{const e=h(t)?await window.$memberstackDom.loginWithProvider(o):await window.$memberstackDom.loginMemberEmailPassword(o);console.log("Signin submit finished:",e)}catch(n){if(window.$memberstackDom._hideLoader(),"code"in n&&("ECONNABORTED"===n.code||"ETIMEDOUT"===n.code)){console.log("Network timeout during login, not showing error to user",n),window.$memberstackDom._hideLoader();const e=localStorage.getItem("_ms-mem");return void(e&&l(e.loginRedirect))}throw await v("Login failed:",n),n}}async function k(e,t){const o=function(e){const t={};return e.querySelectorAll("[data-ms-member]").forEach((e=>{const o=e.getAttribute("data-ms-member");o&&!["email","password","new-password","current-password"].includes(o)&&(t[o]=e.value||"")})),t}(e),{freePlan:n,paidPlan:a}=function(e){return{freePlan:e.getAttribute("data-ms-plan")||e.getAttribute("data-ms-plan:add")||e.getAttribute("data-ms-plan:update"),paidPlan:e.getAttribute("data-ms-price:add")}}(e);let r={customFields:o};if(h(t))r={allowLogin:!1,provider:t.provider};else{if(!b(t))throw new Error("Invalid form authentication options");r={email:t.email,password:t.password}}n&&(r.plans=[{planId:n}]);try{window.$memberstackDom._showLoader(),h(t)?await window.$memberstackDom.signupWithProvider({...r,paidPlan:a}):await window.$memberstackDom.signupMemberEmailPassword({...r,paidPlan:a})}catch(s){await v("Signup failed:",s),window.$memberstackDom._hideLoader()}}function _(e){const t=e.querySelector("[data-ms-member='email']"),o=e.querySelector("[data-ms-member='password']");t&&(t.type="email"),o&&(o.type="password"),e.addEventListener("submit",(async e=>(e.stopImmediatePropagation(),e.preventDefault(),await y(e,"signup"),!1)),!0)}function E(e){const t=e.querySelector("[data-ms-member='email']"),o=e.querySelector("[data-ms-member='password']");t&&(t.type="email"),o&&(o.type="password"),e.addEventListener("submit",(e=>{e.preventDefault(),e.stopImmediatePropagation(),Promise.resolve().then((()=>y(e,"login")))}),!0)}async function D({name:e="my-span",attributes:t={},op:o,description:n,fn:a}){const r=function(){try{const e=window.Sentry;if(!e)throw new Error("Sentry not available");return e}catch(e){return console.error(e),null}}();if(!r)throw new Error("Sentry not available");r?.addBreadcrumb({category:o.split(".")[0],message:n,level:"info"}),r.startSpan({name:e,op:o,attributes:t},(async e=>{try{const t=await a();return e.setStatus({code:1,message:"ok"}),t}catch(t){throw e.setStatus({code:2,message:"internal_error"}),r.captureException(t),t}}))}const I=new c,$="/challenge,/signup,/login,/successful-login".split(",").map((e=>new RegExp(e)));async function L(){var o;if(console.log("ordo auth init"),function(o){if(!o)throw new Error("Memberstack instance is not defined");window._msConfig||(window._msConfig={preventLogin:!0}),window.$memberstackDom=new Proxy(o,{get(o,a){const r=o[a];return"function"==typeof r?async function(...s){if("loginMemberEmailPassword"!==a?console.log(`Method ${a} called with arguments: ${JSON.stringify(s)}`):console.log(`Method ${a} called with arguments: ${JSON.stringify(s[0].email)}, "password": "*****"`),"logout"===a){const t=new CustomEvent(e,{bubbles:!1,cancelable:!1,detail:s[0]});return document.dispatchEvent(t),!1}if("loginMemberEmailPassword"===a){const e=new CustomEvent(t,{bubbles:!1,cancelable:!1,detail:s[0]});return document.dispatchEvent(e),{data:{}}}if("loginWithProvider"===a){let e;try{e=await r.apply(o,s)}catch(i){throw i}const n=new CustomEvent(t,{bubbles:!1,cancelable:!1,detail:e});return document.dispatchEvent(n),e}if("signupWithProvider"===a){let e;const t=s[0],{paidPlan:a,...c}=t;try{e=await r.apply(o,[c])}catch(i){throw i}const d=new CustomEvent(n,{bubbles:!1,cancelable:!1,detail:[e,a]});return document.dispatchEvent(d),e}if("signupMemberEmailPassword"===a){let e;const t=s[0],{paidPlan:a,...c}=t;try{e=await r.apply(o,[c])}catch(i){throw i}const d=new CustomEvent(n,{bubbles:!1,cancelable:!1,detail:[e,a]});return document.dispatchEvent(d),e}if("getMemberCookie"===a){const e=await await r.apply(o,s);return String(e).toString()}return r.apply(o,s)}:r}})}(window.$memberstackDom),window.Webflow=window.Webflow||[],window.Webflow.push((()=>{console.log("document loaded"),function(){const e=document.querySelector('[data-ordo-form="signup"]'),t=document.querySelector('[data-ms-form="signup"]');e&&_(e),t&&_(t),e||t||console.warn("no signup form found.");const o=document.querySelector('[data-ordo-form="login"]'),n=document.querySelector('[data-ms-form="login"]');o&&E(o),n&&E(n),o||n||console.warn("no login form found."),(document.querySelectorAll('[data-ordo-auth-provider="google"]').length?document.querySelectorAll('[data-ordo-auth-provider="google"]'):document.querySelectorAll('[data-ms-auth-provider="google"]')).forEach((e=>{e.addEventListener("click",(t=>{const o=e.closest("[data-ordo-form]")||e.closest("[data-ms-form]");o&&(t.stopImmediatePropagation(),t.preventDefault(),"signup"===o.getAttribute("data-ms-form")?Promise.resolve().then((()=>k(o,{provider:"google"}))):Promise.resolve().then((()=>S(0,{provider:"google"}))))}),!0)})),(document.querySelectorAll('[data-ordo-action="logout"]').length?document.querySelectorAll('[data-ordo-action="logout"]'):document.querySelectorAll('[data-ms-action="logout"]')).forEach((e=>{const t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e),t.addEventListener("click",(async function(e){e.stopImmediatePropagation(),e.preventDefault(),await window.$memberstackDom.logout()}),!0)}))}()})),o=location.href,$.some((e=>e.test(o))))console.log("Avoided verification on excluded page");else if(console.log("getApp verification"),m())try{const e=await I.validateSessionStatus();if(console.log("isStatusValid",e),!1===e)return void(await window.$memberstackDom.logout());w(!0)}catch(a){if(a instanceof s)return void(401!==a.status&&403!==a.status||await window.$memberstackDom.logout({isExpired:!0}))}else w("unauthenticated")}!async function(){window.$memberstackReady?await L():document.addEventListener("memberstack.ready",(async()=>{await L()}))}(),document.addEventListener(e,(async e=>{const{detail:t}=e;if(console.log("logout"),!m())return void console.log("Member is not logged in.");if(t?.isExpired)await window.$memberstackDom._showMessage("Votre session a expiré. Veuillez vous reconnecter.",!0);else try{await I.logout()}catch(n){if(n instanceof s){if(401===n.status||403===n.status)return void console.log("Member is already logged out from the server.");throw await window.$memberstackDom._showMessage("Il y a eu une erreur avec votre demande.",!0),console.error(n),n}}const o=p();await D({name:"User Logout",attributes:{userSessionLifetime:o.formatted,userSessionLifeTimeHours:o.hours,userSessionLifeTimeMinutes:o.minutes,userSessionLifeTimeSeconds:o.seconds,userSessionSourceURL:document.referrer,userSessionRef:localStorage.getItem("_ms-mid")||"undefined"},op:"auth.logout",description:"User logged out",fn:async()=>await u(0,"/")})})),document.addEventListener(t,(async e=>{console.log("start login event");const t=e.detail;if(!t&&m())return console.log("Member is already logged in."),window.$memberstackDom._hideLoader(),void(await window.$memberstackDom._showMessage("Vous êtes déjà connecté.",!0));function o(e){return"email"in e&&"password"in e}try{if(o(t)){const e=await I.login({email:t.email,password:t.password});localStorage.setItem("_ms-mid",e.data.tokens.accessToken),localStorage.setItem("_ms-mem",JSON.stringify(e.data.member)),console.log("login successful with email and password"),f(),l(e.data.member.loginRedirect),window.$memberstackDom._hideLoader()}else{const e=await I.loginWithProvider({loginResponse:t});if(null===e){const e=JSON.parse(localStorage.getItem("_ms-mem")||"{}");return void l(e?e.loginRedirect:"/")}console.log("login successful with provider"),f(),l(e.data.member.loginRedirect),window.$memberstackDom._hideLoader()}}catch(n){if(n instanceof i){const e=(a(),"/membership/connexion-2fa");localStorage.removeItem("_ms-mid"),localStorage.removeItem("_ms-mem"),sessionStorage.removeItem("_ms-2fa-session"),sessionStorage.removeItem("timer_timeLeft"),sessionStorage.removeItem("otp_timer_timeLeft"),sessionStorage.removeItem("_ms-2fa-timer"),sessionStorage.removeItem("_ms-2fa-timer-start");let r="";r=o(t)?t.email:n.data.email||"unknown",sessionStorage.setItem("ms_email",r);const s="_ms-2fa-session",i=JSON.stringify({data:n.data,type:n.type});return sessionStorage.setItem(s,i),void l(e)}if(n instanceof s)return await window.$memberstackDom._showMessage(n.message,!0),void window.$memberstackDom._hideLoader();if("code"in n&&("ECONNABORTED"===n.code||"ETIMEDOUT"===n.code)){console.log("Network timeout during login, not showing error to user",n),window.$memberstackDom._hideLoader();const e=localStorage.getItem("_ms-mem");return void(e&&l(e.loginRedirect))}throw await window.$memberstackDom._showMessage("Il y a eu une erreur avec votre demande.",!0),console.error({loginError:n}),window.$memberstackDom._hideLoader(),n}console.log("end login event")}),{capture:!0}),document.addEventListener(n,(async e=>{const[t,o]=e.detail;try{await I.signup({token:t.data.tokens.accessToken}),o?await window.$memberstackDom.purchasePlansWithCheckout({priceId:o}):l(t.data.redirect),window.$memberstackDom._hideLoader()}catch(n){if(n instanceof s)return"User already exists"===n.message?await window.$memberstackDom._showMessage("L'email fourni est déjà utilisé, cliquez sur 'Connectez-vous'",!0):await window.$memberstackDom._showMessage(n.message,!0),void window.$memberstackDom._hideLoader();throw await window.$memberstackDom._showMessage("Il y a eu une erreur avec votre demande.",!0),window.$memberstackDom._hideLoader(),console.error(n),n}}),{capture:!0})}));
